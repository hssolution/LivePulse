# ğŸ‰ Auth Hook ìµœì¢… í•´ê²° ê°€ì´ë“œ

## ë°œìƒí–ˆë˜ ëª¨ë“  ì—ëŸ¬ë“¤

### 1. âŒ "Error running hook URL"
- **ì›ì¸**: SECURITY DEFINER ì—†ìŒ
- **í•´ê²°**: âœ… í•¨ìˆ˜ì— `SECURITY DEFINER` ì¶”ê°€

### 2. âŒ "500: output claims field is missing"
- **ì›ì¸**: Hookì´ `{"claims": {...}}` í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ì§€ ì•ŠìŒ
- **í•´ê²°**: âœ… `return jsonb_build_object('claims', claims)` ì¶”ê°€

### 3. âš ï¸ "output claims do not conform to the expected schema"
- **ì›ì¸**: ë‚´ë¶€ ê²€ì¦ ë©”ì‹œì§€ (ì •ìƒ ì‘ë™ ê°€ëŠ¥)
- **í•´ê²°**: ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ í›„ ì¬ì‹œë„

---

## âœ… ìµœì¢… Hook í•¨ìˆ˜

```sql
CREATE OR REPLACE FUNCTION public.custom_access_token_hook(event jsonb)
RETURNS jsonb
LANGUAGE plpgsql
STABLE
SECURITY DEFINER  -- ì¤‘ìš”!
SET search_path = public
AS $$
declare
  claims jsonb;
  profile_record record;
begin
  -- í”„ë¡œí•„ ì •ë³´ ì¡°íšŒ
  select 
    email,
    role,
    user_type,
    status,
    description
  into profile_record
  from public.profiles
  where id = (event->>'user_id')::uuid;

  -- ì»¤ìŠ¤í…€ í´ë ˆì„ ìƒì„±
  if profile_record.user_type is not null then
    claims := jsonb_build_object(
      'email', profile_record.email,
      'role', profile_record.role,
      'user_type', profile_record.user_type,
      'status', profile_record.status,
      'description', profile_record.description
    );
  else
    claims := jsonb_build_object(
      'user_type', 'general',
      'status', 'pending',
      'role', 'user'
    );
  end if;

  -- ì¤‘ìš”: claims í•„ë“œë¡œ ê°ì‹¸ì„œ ë°˜í™˜!
  return jsonb_build_object('claims', claims);
end;
$$;
```

---

## ğŸ¯ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸

1. **ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨** (Ctrl + F5)
2. **ë¡œê·¸ì¸ í˜ì´ì§€**: `http://localhost:5173/login`
3. **ë¡œê·¸ì¸**
   - ì´ë©”ì¼: `lhscj2466@gmail.com`
   - ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
4. **ì„±ê³µ í™•ì¸**
   - ì—ëŸ¬ ì—†ì´ ë¡œê·¸ì¸
   - Dashboardë¡œ ì´ë™
   - ì½˜ì†”ì—ì„œ í”„ë¡œí•„ ì •ë³´ í™•ì¸

---

## ğŸ§ª í™•ì¸ ë°©ë²•

ë¡œê·¸ì¸ í›„ ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ:

```javascript
// ì„¸ì…˜ í™•ì¸
const { data } = await supabase.auth.getSession()
console.log('Session:', data.session)

// JWT ë””ì½”ë”©
const token = data.session.access_token
const payload = JSON.parse(atob(token.split('.')[1]))
console.log('JWT Payload:', payload)

// í”„ë¡œí•„ ì •ë³´ í™•ì¸
console.log('Profile:', {
  email: payload.email,
  role: payload.role,
  userType: payload.user_type,
  status: payload.status,
  description: payload.description
})
```

### ì˜ˆìƒ ê²°ê³¼

```javascript
{
  // ê¸°ë³¸ JWT í•„ë“œ (Supabaseê°€ ìë™ ì¶”ê°€)
  aud: "authenticated",
  exp: 1234567890,
  iat: 1234567890,
  sub: "b2019fe5-e8b8-4552-aad2-dbbcf0202bce",
  
  // ìš°ë¦¬ì˜ ì»¤ìŠ¤í…€ í•„ë“œ âœ…
  email: "lhscj2466@gmail.com",
  role: "admin",
  user_type: "admin",
  status: "active",
  description: "ì‹œìŠ¤í…œ ê´€ë¦¬ì"
}
```

---

## ğŸ’¡ ì‘ë™ ì›ë¦¬

```
ë¡œê·¸ì¸ ìš”ì²­
    â†“
Supabase Auth ì¸ì¦
    â†“
custom_access_token_hook ì‹¤í–‰
    â†“
profiles í…Œì´ë¸” ì¡°íšŒ
    â†“
ì»¤ìŠ¤í…€ í´ë ˆì„ ìƒì„±: {claims: {...}}
    â†“
Supabase Authê°€ ê¸°ë³¸ JWT í•„ë“œì™€ ë³‘í•©
    â†“
ìµœì¢… JWT í† í° ìƒì„± (ê¸°ë³¸ í•„ë“œ + ì»¤ìŠ¤í…€ í•„ë“œ)
    â†“
í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ë‹¬
```

---

## ğŸš¨ ë¬¸ì œ í•´ê²°

### ì—¬ì „íˆ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´

1. **ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ**
   ```javascript
   localStorage.clear()
   sessionStorage.clear()
   window.location.reload()
   ```

2. **ì‹œí¬ë¦¿ ëª¨ë“œ í…ŒìŠ¤íŠ¸**
   - Ctrl + Shift + N
   - ì™„ì „íˆ ìƒˆë¡œìš´ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸

3. **Supabase ì¬ì‹œì‘**
   ```bash
   npx supabase stop
   npx supabase start
   ```

4. **Docker ë¡œê·¸ í™•ì¸**
   ```bash
   docker logs supabase_auth_web_test_001 --tail 20
   ```
   - "Hook errored out" ë©”ì‹œì§€ê°€ ì—†ì–´ì•¼ í•¨
   - ì •ìƒ: "audit_event" ë¡œê·¸ë§Œ í‘œì‹œ

---

## ğŸ‰ ì„±ê³µ í™•ì¸

### í—¤ë”
```
lhscj2466@gmail.com  [admin] [admin] [active]
```

### Dashboard
```
í™˜ì˜í•©ë‹ˆë‹¤, lhscj2466@gmail.comë‹˜!
í˜„ì¬ ìƒíƒœ: active
```

### Profile Test í˜ì´ì§€
```
Email: lhscj2466@gmail.com
Role: admin
User Type: admin
Status: active
Description: ì‹œìŠ¤í…œ ê´€ë¦¬ì
```

---

## ğŸ“š í•µì‹¬ í¬ì¸íŠ¸

1. **SECURITY DEFINER í•„ìˆ˜**: Auth ì„œë¹„ìŠ¤ê°€ profiles í…Œì´ë¸” ì ‘ê·¼ ê°€ëŠ¥
2. **claims í•„ë“œë¡œ ê°ì‹¸ê¸°**: `{"claims": {...}}` í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
3. **ì»¤ìŠ¤í…€ í•„ë“œë§Œ ë°˜í™˜**: ê¸°ë³¸ JWT í•„ë“œëŠ” Supabaseê°€ ìë™ ì¶”ê°€
4. **ê¶Œí•œ ì„¤ì •**: supabase_auth_adminì— EXECUTE ê¶Œí•œ ë¶€ì—¬

---

ì´ì œ ì™„ë²½í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤! ğŸš€

