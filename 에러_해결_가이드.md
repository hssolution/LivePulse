# 🔧 에러 해결 가이드

## 발생했던 에러들과 해결 방법

### 1. ❌ Invalid Refresh Token Error

**에러 메시지:**
```
AuthApiError: Invalid Refresh Token: Refresh Token Not Found
Failed to load resource: the server responded with a status of 400 (Bad Request)
```

**원인:**
- 브라우저 localStorage에 오래되거나 손상된 인증 토큰이 남아있음
- Supabase 로컬 개발 환경을 재시작하면서 토큰이 무효화됨

**해결 방법:**

#### 방법 1: 자동 정리 (구현됨 ✅)
- AuthContext가 자동으로 감지하고 정리
- 페이지가 자동으로 새로고침됨

#### 방법 2: 수동 정리
브라우저 콘솔에서 실행:
```javascript
window.clearAuth()
```

#### 방법 3: 브라우저에서 직접 삭제
1. F12 (개발자 도구)
2. Application 탭
3. Local Storage → `http://localhost:3000`
4. `sb-` 로 시작하는 모든 키 삭제
5. 페이지 새로고침

---

### 2. ❌ 406 Not Acceptable Error (app_config)

**에러 메시지:**
```
Failed to load resource: the server responded with a status of 406 (Not Acceptable)
127.0.0.1:54321/rest/v1/app_config?select=*&key=eq.admin_initialized
```

**원인:**
- `.single()` 메서드는 데이터가 없으면 에러를 반환
- 첫 회원가입 시 `app_config` 테이블이 비어있어서 발생

**해결 방법:** ✅ 수정 완료
```javascript
// 변경 전
.single()  // 데이터 없으면 에러

// 변경 후
.maybeSingle()  // 데이터 없어도 에러 안남
```

---

### 3. ❌ jwt-decode 패키지 없음

**에러 메시지:**
```
Failed to resolve import "jwt-decode" from "src/context/AuthContext.jsx"
```

**원인:**
- `jwt-decode` 패키지가 설치되지 않음

**해결 방법:** ✅ 설치 완료
```bash
npm install jwt-decode
```

---

## 🛠️ 구현된 에러 처리 기능

### 1. 자동 토큰 정리
`src/utils/authCleanup.js`에 유틸리티 함수 구현:

```javascript
// 손상된 토큰 자동 감지 및 정리
handleAuthError(error)

// 수동 정리 (콘솔에서 사용)
window.clearAuth()
```

### 2. AuthContext 에러 처리 강화
- 세션 에러 자동 감지
- 손상된 토큰 자동 정리
- 필요 시 자동 페이지 새로고침
- 로그아웃 이벤트 명시적 처리

### 3. Signup 페이지 개선
- `.maybeSingle()` 사용으로 406 에러 방지
- 에러 로깅 추가
- 안전한 fallback 처리

---

## 🧪 에러 테스트 방법

### 테스트 1: Refresh Token 에러 재현
1. 로그인
2. Supabase 로컬 서버 재시작:
   ```bash
   npx supabase stop
   npx supabase start
   ```
3. 페이지 새로고침
4. 자동으로 토큰이 정리되고 재로드됨 ✅

### 테스트 2: app_config 에러 해결 확인
1. 회원가입 페이지 방문
2. 콘솔에서 406 에러가 발생하지 않음 ✅
3. 정상적으로 관리자/파트너 모드 판단됨 ✅

---

## 🎯 현재 상태

### ✅ 해결된 에러들
- [x] Invalid Refresh Token 에러
- [x] 406 Not Acceptable 에러 (app_config)
- [x] jwt-decode 패키지 없음 에러

### ✅ 구현된 기능들
- [x] 자동 토큰 정리
- [x] 에러 감지 및 복구
- [x] 안전한 에러 처리
- [x] 개발자 친화적 디버깅 도구

---

## 💡 개발 팁

### 콘솔 명령어
```javascript
// 인증 데이터 정리
window.clearAuth()

// 현재 세션 확인
const { data } = await supabase.auth.getSession()
console.log(data)

// 현재 사용자 확인
const { data } = await supabase.auth.getUser()
console.log(data)
```

### 로그 확인
AuthContext는 다음 정보를 자동으로 콘솔에 출력:
- `Auth state changed: [이벤트]` - 인증 상태 변경
- `AuthContext: Decoded JWT` - JWT 디코딩 결과
- `AuthContext: Profile data` - 프로필 정보

### 문제 해결 순서
1. **브라우저 콘솔 확인** - 에러 메시지 확인
2. **window.clearAuth() 실행** - 토큰 정리
3. **페이지 새로고침** - 상태 초기화
4. **로그아웃 후 재로그인** - 새 토큰 발급
5. **Supabase 서버 재시작** - 마지막 수단

---

## 📚 관련 문서

- [Supabase Auth 에러 처리](https://supabase.com/docs/guides/auth/server-side/error-handling)
- [JWT 디버깅](https://jwt.io/)
- [프로필 세션 연동 가이드](./PROFILE_SESSION_GUIDE.md)

---

## 🎉 결론

모든 에러가 해결되었고, 안정적인 에러 처리 시스템이 구축되었습니다!

이제 다음과 같은 상황에서도 안전하게 작동합니다:
- ✅ 서버 재시작
- ✅ 토큰 만료
- ✅ 손상된 세션
- ✅ 첫 회원가입
- ✅ 네트워크 에러

문제가 발생하면 자동으로 복구되며, 필요 시 수동 정리 도구도 제공됩니다! 🚀

